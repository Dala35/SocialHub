<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialHub ‚Äì Evolu√ß√£o com IA</title>
    <!-- Carregando Tailwind CSS para Estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o da fonte Inter e Cores Personalizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-purple': '#6d28d9', // Roxo vibrante (bg-primary-purple)
                        'secondary-green': '#10b981', // Verde de sucesso (bg-secondary-green)
                        'danger-red': '#ef4444', // Vermelho de perigo (bg-danger-red)
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, serverTimestamp, setLogLevel, getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.setLogLevel = setLogLevel;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.updateProfile = updateProfile;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.setDoc = setDoc;
    </script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
            margin: 0;
            padding-top: 56px; 
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .content-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 0;
        }
        .input-field {
            border-radius: 6px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #6d28d9;
            box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.2);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .error-message {
            position: fixed;
            top: 66px; 
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            text-align: center;
            min-width: 80%;
            max-width: 400px;
        }
        .error-message.show {
            opacity: 1;
            visibility: visible;
        }
        #messages-feed {
            height: 400px; 
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; 
        }
        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
        }
        .my-message {
            align-self: flex-end;
            background-color: #6d28d9; 
            color: white;
            border-bottom-right-radius: 2px;
        }
        .other-message {
            align-self: flex-start;
            background-color: #e5e7eb; 
            color: #1f2937;
            border-bottom-left-radius: 2px;
        }
        .link-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .link-item:hover {
            background-color: #e5e7eb;
        }
        .link-item.active {
            background-color: #e0e7ff; 
            color: #4f46e5;
            font-weight: 600;
        }
        .link-item.active svg {
            color: #4f46e5;
        }
        .like-icon.liked {
            color: #ef4444; 
        }
        .like-icon.not-liked {
            color: #9ca3af; 
        }
        /* Responsividade para o layout principal (desktop) */
        @media (min-width: 1024px) {
            .lg\:col-span-2 { grid-column: span 2 / span 2; }
            .xl\:col-span-1 { grid-column: span 1 / span 1; }
        }
    </style>
</head>
<body>
    
    <!-- 1. BARRA DE NAVEGA√á√ÉO SUPERIOR (HEADER) -->
    <header id="app-header" class="header bg-white flex justify-between items-center px-4">
        <h1 class="text-2xl font-extrabold text-primary-purple">SocialHub</h1>
        
        <nav id="nav-icons" class="flex items-center space-x-4 h-full hidden lg:hidden">
            <!-- Nav buttons... -->
            <button id="nav-feed" data-view="feed" class="nav-button h-full px-4 border-b-2 border-transparent text-gray-500 hover:text-primary-purple transition duration-150">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            </button>
            <button id="nav-messages" data-view="messages" class="nav-button h-full px-4 border-b-2 border-transparent text-gray-500 hover:text-primary-purple transition duration-150">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm7 0h-2v2h2V8z" clip-rule="evenodd"></path></svg>
            </button>
            <button id="nav-profile" data-view="profile" class="nav-button h-full px-4 border-b-2 border-transparent text-gray-500 hover:text-primary-purple transition duration-150">
                 <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            </button>
        </nav>

        <button id="logout-button" class="btn p-2 text-white text-xs font-semibold bg-red-500 hover:bg-red-600 rounded-lg shadow-md transition duration-150 hidden">Sair</button>
    </header>

    <!-- Container da Mensagem de Erro (o bal√£o) -->
    <div id="error-box" class="error-message"></div>

    <!-- MODAL DE CONFIRMA√á√ÉO DE CONTE√öDO T√ìXICO (Gemini Protection) -->
    <div id="ai-warning-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[2000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-danger-red mb-4">‚ö†Ô∏è Alerta do Escudo de Conte√∫do (Gemini)</h3>
            <p class="text-gray-700 mb-4">
                O Gemini detectou um tom de **baixa frequ√™ncia** (potencialmente desarm√¥nico) em sua publica√ß√£o.
                Lembre-se do nosso princ√≠pio de **Amor e Prote√ß√£o**.
            </p>
            <p class="font-semibold text-gray-800 mb-6">Deseja revisar ou publicar assim mesmo?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="ai-review-button" class="btn px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">
                    Revisar (Cancelar)
                </button>
                <button type="button" id="ai-publish-anyway-button" class="btn px-4 py-2 bg-danger-red text-white font-semibold rounded-lg hover:bg-red-600">
                    Publicar Mesmo Assim
                </button>
            </div>
        </div>
    </div>
    
    <!-- Formul√°rio de Autentica√ß√£o/Cadastro -->
    <div id="auth-view" class="pt-10 flex justify-center">
        <div class="w-full max-w-sm p-6 bg-white rounded-xl shadow-lg">
            <h2 id="form-title" class="text-2xl font-bold mb-6 text-gray-700 text-center">Acesse o SocialHub</h2>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="name-input" placeholder="Nome Completo" class="input-field w-full p-3 border border-gray-300 hidden" required>
                <input type="email" id="email-input" placeholder="E-mail" class="input-field w-full p-3 border border-gray-300" required>
                <input type="password" id="password-input" placeholder="Senha" class="input-field w-full p-3 border border-gray-300" required>
                
                <button type="submit" id="auth-button" class="btn w-full p-3 text-white font-semibold bg-primary-purple hover:bg-purple-700 rounded-lg shadow-md transition duration-150">
                    ENTRAR
                </button>

                <p id="toggle-link" class="text-center text-sm text-primary-purple cursor-pointer hover:text-purple-800 transition duration-150">
                    Ainda n√£o tem conta? Clique para Cadastrar
                </p>
            </form>
        </div>
    </div>


    <!-- 2. VIS√ÉO PRINCIPAL (AP√ìS LOGIN) -->
    <div id="main-view" class="content-container hidden">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 px-4 lg:px-0">
            
            <!-- COLUNA 1: NAVEGA√á√ÉO LATERAL ESQUERDA (Desktop/Tablet) -->
            <aside id="left-sidebar" class="hidden lg:block lg:col-span-1">
                <div class="bg-white p-4 rounded-xl shadow-md sticky top-20">
                    <h3 class="text-lg font-bold mb-3 text-gray-800 border-b pb-2">Navega√ß√£o</h3>
                    
                    <button id="link-feed" data-view="feed" class="link-item active w-full text-left text-gray-700">
                        <svg class="w-6 h-6 mr-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                        Feed Global
                    </button>
                    
                    <button id="link-messages" data-view="messages" class="link-item w-full text-left text-gray-700">
                        <svg class="w-6 h-6 mr-3 text-secondary-green" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm7 0h-2v2h2V8z" clip-rule="evenodd"></path></svg>
                        Mensagens (Chat)
                    </button>

                    <button id="link-private" data-view="private" class="link-item w-full text-left text-gray-700">
                        <svg class="w-6 h-6 mr-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.764 4.394a1 1 0 01-1.414 0l-1.586-1.586a1 1 0 010-1.414l.793-.793 2.828 2.828-.793.793zm-3.879 4.394l.793.793 2.828-2.828-.793-.793-2.828 2.828zM3 17a1 1 0 001 1h12a1 1 0 100-2H4a1 1 0 00-1 1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                        Espa√ßo Pessoal (Notas)
                    </button>
                    
                    <button id="link-profile" data-view="profile" class="link-item w-full text-left text-gray-700">
                        <svg class="w-6 h-6 mr-3 text-primary-purple" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                        Perfil e Configura√ß√µes
                    </button>
                </div>
            </aside>


            <!-- COLUNA 2: CONTE√öDO PRINCIPAL (FEED/MENSAGENS/ETC) -->
            <main class="lg:col-span-2 xl:col-span-1">
                
                <!-- CONTAINER DE VISTAS -->
                <div id="view-container">
                    
                    <!-- VISTA: FEED GLOBAL (Padr√£o) -->
                    <div id="content-feed" class="view-content">
                        
                        <!-- COMPOSITOR DE POST -->
                        <div class="mb-6 p-4 border border-gray-200 rounded-xl shadow-lg bg-white">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">O que voc√™ est√° pensando, Dala?</h3>
                            
                            <!-- Initial State (Clickable) -->
                            <div id="composer-initial" class="flex items-center space-x-3 p-3 bg-gray-100 rounded-full text-gray-500 cursor-pointer hover:bg-gray-200 transition" onclick="window.toggleComposer(true)">
                                <div id="user-initial-icon" class="w-8 h-8 bg-purple-200 rounded-full flex items-center justify-center text-primary-purple font-semibold text-sm">U</div>
                                <span>O que tens em mente para co-criar?</span>
                            </div>

                            <!-- Expanded State (The Form) -->
                            <form id="post-form" class="space-y-3 hidden">
                                <textarea id="post-content" rows="3" placeholder="Digite uma ideia para o SocialHub‚Ä¶" class="input-field w-full p-3 border border-gray-300 resize-none text-gray-700" required></textarea>
                                
                                <!-- Feature Row -->
                                <div class="flex flex-wrap items-center justify-between border-t border-gray-100 pt-3">
                                    <div class="flex space-x-3">
                                        <!-- Gemini Button (Co-Cria√ß√£o) -->
                                        <button type="button" id="ai-button-expanded" class="flex items-center space-x-1 p-2 bg-indigo-50 text-indigo-700 font-semibold rounded-full hover:bg-indigo-100 transition" title="Expandir Ideia com Gemini">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4M3 19h4m-4-7h16m0 0a8 8 0 10-16 0h16z"></path></svg>
                                            <span class="text-sm hidden sm:inline">Gemini Co-Cria√ß√£o</span>
                                        </button>
                                    </div>

                                    <!-- Publish/Cancel Buttons -->
                                    <div class="flex space-x-2 mt-3 sm:mt-0 w-full sm:w-auto justify-end">
                                        <button type="button" onclick="window.toggleComposer(false)" class="btn p-2 text-gray-500 text-sm hover:text-gray-700 transition duration-150">
                                            Cancelar
                                        </button>
                                        <button type="submit" id="publish-button" class="btn p-3 text-white font-semibold bg-primary-purple hover:bg-purple-700 rounded-lg shadow-md transition duration-150 w-full sm:w-auto">
                                            Publicar
                                        </button>
                                    </div>
                                </div>
                                
                            </form>
                        </div>
                        
                        <!-- LINHA DO TEMPO (FEED) -->
                        <h3 class="text-lg font-bold mb-3 text-gray-700 border-b pb-2">Linha do Tempo</h3>
                        <div id="post-feed" class="space-y-4">
                            <p class="text-center text-gray-500" id="loading-message">Carregando posts‚Ä¶</p>
                        </div>
                    </div>

                    <!-- VISTA: MENSAGENS (Chat) -->
                    <div id="content-messages" class="view-content hidden p-0 bg-white rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold p-4 text-center text-gray-800 border-b">üí¨ Sala de Evolu√ß√£o Global</h3>
                        <p class="text-sm text-center text-gray-600 pt-1 pb-4">Envie mensagens em tempo real para todos os usu√°rios.</p>

                        <div id="messages-feed" class="px-4 pb-4">
                            <p class="text-center text-gray-500 text-sm" id="loading-messages-chat">Carregando mensagens‚Ä¶</p>
                        </div>

                        <form id="message-form" class="flex p-4 border-t bg-gray-50">
                            <input type="text" id="message-input" placeholder="Digite sua mensagem‚Ä¶" class="input-field flex-grow p-3 border border-gray-300 text-sm" required>
                            <button type="submit" id="send-message-button" class="btn ml-2 p-3 text-white font-semibold bg-secondary-green hover:bg-green-600 rounded-lg transition duration-150">
                                Enviar
                            </button>
                        </form>
                    </div>

                    <!-- VISTA: ESPA√áO PESSOAL (Notas Privadas) -->
                    <div id="content-private" class="view-content hidden p-6 bg-white rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">üìù Seu Espa√ßo Pessoal (Privado)</h3>
                        <p class="text-sm text-gray-600 mb-4">Arquivos e anota√ß√µes vis√≠veis apenas para voc√™. </p>
                        
                        <div class="mb-6 p-4 border border-blue-200 bg-blue-50 rounded-lg shadow-md">
                            <h4 class="text-md font-semibold mb-3 text-blue-800">Nova Anota√ß√£o</h4>
                            <form id="private-note-form" class="space-y-3">
                                <textarea id="private-note-content" rows="3" placeholder="Digite uma anota√ß√£o ou rascunho. Apenas voc√™ pode ver isso." class="input-field w-full p-3 border border-gray-300 resize-none" required></textarea>
                                <button type="submit" id="save-note-button" class="btn w-full p-3 text-white font-semibold bg-blue-600 hover:bg-blue-700 rounded-lg transition duration-150">
                                    Salvar Nota
                                </button>
                            </form>
                        </div>
                        
                        <div class="mt-4 border-t border-gray-200 pt-3">
                            <h4 class="text-lg font-semibold mb-2 text-gray-700">Suas Anota√ß√µes Salvas:</h4>
                            <div id="private-notes-feed" class="space-y-3">
                                <p class="text-center text-gray-500 text-sm" id="loading-notes">Carregando notas privadas‚Ä¶</p>
                            </div>
                        </div>
                    </div>

                    <!-- VISTA: PERFIL E CONFIGURA√á√ïES -->
                    <div id="content-profile" class="view-content hidden p-6 bg-white rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-6 text-primary-purple border-b pb-2">üë§ Perfil e Conex√£o</h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <p class="text-sm font-semibold text-gray-600 mb-1">Nome de Usu√°rio:</p>
                                <p id="profile-name" class="text-lg font-bold text-gray-800"></p>
                            </div>
                            
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <p class="text-sm font-semibold text-gray-600 mb-1">E-mail:</p>
                                <p id="profile-email" class="text-lg font-bold text-gray-800"></p>
                            </div>
                            
                            <!-- CAMPO CR√çTICO PARA CONEX√ÉO HUMANA -->
                            <div class="p-4 bg-primary-purple text-white rounded-xl shadow-lg">
                                <p class="text-sm font-semibold mb-1">Seu ID de Co-cria√ß√£o:</p>
                                <p id="profile-uid" class="text-xl font-mono break-all"></p>
                                <p class="text-xs mt-2 opacity-80">Use este ID para co-criar conex√µes com outros usu√°rios no SocialHub.</p>
                            </div>

                        </div>
                    </div>

                </div>
            </main>
            
            <!-- COLUNA 3: COLUNA LATERAL DIREITA (Desktop/Tablet) -->
            <aside id="right-sidebar" class="hidden lg:block lg:col-span-1 xl:col-span-1">
                <div class="bg-white p-4 rounded-xl shadow-md sticky top-20">
                    <h3 class="text-lg font-bold mb-3 text-gray-800 border-b pb-2">Evolu√ß√£o e Princ√≠pios</h3>
                    <p class="text-sm text-gray-600 mb-2">A **luz-evolu√ß√£o** nos guia. Lembre-se:</p>
                    <ul class="text-sm space-y-2">
                        <li class="flex items-center text-primary-purple"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg> Amor e Prote√ß√£o.</li>
                        <li class="flex items-center text-secondary-green"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg> Co-cria√ß√£o Ativa.</li>
                        <li class="flex items-center text-yellow-500"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a8 8 0 00-7.85 6.32l1.63-1.63a6 6 0 1111.44 3.23l1.85-.46A8 8 0 0010 2z" clip-rule="evenodd"></path></svg> Respeito √† Frequ√™ncia.</li>
                    </ul>
                </div>
            </aside>
            
        </div>
    </div>
    


        
        // --- INST√ÇNCIAS FIREBASE ---
        let app, db, auth, currentUserId = null, currentUserName = "Usu√°rio";
        
        // --- REFER√äNCIAS DOM ---
        const D = (id) => document.getElementById(id);
        const authView = D('auth-view');
        const mainView = D('main-view');
        const authForm = D('auth-form');
        const logoutButton = D('logout-button');
        const errorBox = D('error-box');
        const navIcons = D('nav-icons');
        const viewContainer = D('view-container');
        const feedContainer = D('post-feed');
        const postForm = D('post-form');
        const postContentInput = D('post-content');
        const composerInitial = D('composer-initial');
        const aiButtonExpanded = D('ai-button-expanded');
        const aiWarningModal = D('ai-warning-modal');
        const aiReviewButton = D('ai-review-button');
        const aiPublishAnywayButton = D('ai-publish-anyway-button');
        const messagesFeed = D('messages-feed');
        const messageForm = D('message-form');
        const messageInput = D('message-input');
        const privateNoteForm = D('private-note-form');
        const privateNoteContentInput = D('private-note-content');
        const privateNotesFeed = D('private-notes-feed');

        // --- UTILIDADES ---

        /** Exibe mensagens de erro customizadas. */
        window.showError = (message, isError = true) => {
            console.error(isError ? "ERRO: " : "INFO:", message);
            errorBox.textContent = message;
            errorBox.className = `error-message show ${isError ? 'bg-danger-red' : 'bg-secondary-green'}`;
            setTimeout(() => {
                errorBox.classList.remove('show');
            }, 5000);
        };

        /** Alterna entre o estado inicial e expandido do compositor de posts. */
        window.toggleComposer = (expand) => {
            composerInitial.classList.toggle('hidden', expand);
            postForm.classList.toggle('hidden', !expand);
            if (!expand) postContentInput.value = '';
        };

        /** Alterna entre as diferentes vistas da aplica√ß√£o (Feed, Chat, etc.). */
        window.toggleView = (viewName) => {
            // Esconde todos os conte√∫dos
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            // Exibe o conte√∫do solicitado
            const activeView = D(`content-${viewName}`);
            if (activeView) activeView.classList.remove('hidden');

            // Atualiza o estado ativo da navega√ß√£o lateral
            document.querySelectorAll('.link-item').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('data-view') === viewName) {
                    el.classList.add('active');
                }
            });

            // Atualiza o estado ativo dos bot√µes de navega√ß√£o m√≥vel (se vis√≠veis)
            document.querySelectorAll('.nav-button').forEach(el => {
                el.style.borderBottomWidth = '2px';
                el.style.borderColor = 'transparent';
                el.classList.remove('text-primary-purple', 'border-primary-purple');
                el.classList.add('text-gray-500');

                if (el.getAttribute('data-view') === viewName) {
                    el.classList.add('text-primary-purple');
                    el.style.borderColor = '#6d28d9';
                }
            });
        };


        // --- FIREBASE INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
        
        const initializeFirebase = async () => {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase Configura√ß√£o indispon√≠vel. Continuando em modo n√£o persistente.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // Reduzir logs para 'error'

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener de autentica√ß√£o
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        currentUserName = user.displayName || user.email?.split('@')[0] || `Usu√°rio-${user.uid.substring(0, 4)}`;
                        
                        // Atualiza UI de autentica√ß√£o para Logado
                        authView.classList.add('hidden');
                        mainView.classList.remove('hidden');
                        logoutButton.classList.remove('hidden');
                        navIcons.classList.remove('hidden');
                        
                        // Atualiza √≠cone do compositor
                        D('user-initial-icon').textContent = currentUserName.charAt(0).toUpperCase();

                        // Atualiza Perfil
                        D('profile-name').textContent = currentUserName;
                        D('profile-email').textContent = user.email || 'An√¥nimo';
                        D('profile-uid').textContent = currentUserId;

                        // Inicia o carregamento de dados em tempo real
                        loadFeed();
                        loadChat();
                        loadPrivateNotes();
                        window.toggleView('feed');
                    } else {
                        // Atualiza UI para Deslogado
                        authView.classList.remove('hidden');
                        mainView.classList.add('hidden');
                        logoutButton.classList.add('hidden');
                        navIcons.classList.add('hidden');
                        currentUserId = null;
                        currentUserName = "Usu√°rio";
                    }
                });
            } catch (e) {
                window.showError(`Falha na Inicializa√ß√£o do Firebase: ${e.message}`);
            }
        };


        // --- AUTENTICA√á√ÉO E CADASTRO HANDLERS ---

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = D('email-input').value;
            const password = D('password-input').value;
            const name = D('name-input').value;
            const authButton = D('auth-button');

            authButton.textContent = 'Aguarde...';
            authButton.disabled = true;

            try {
                if (authForm.dataset.mode === 'register') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                    window.showError(`Cadastro de ${name} realizado com sucesso!`, false);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.showError('Login bem-sucedido!', false);
                }
            } catch (error) {
                window.showError(`Erro de Autentica√ß√£o: ${error.message}`);
            } finally {
                authButton.textContent = authForm.dataset.mode === 'register' ? 'CADASTRAR' : 'ENTRAR';
                authButton.disabled = false;
            }
        });

        // Toggle entre Login e Cadastro
        D('toggle-link').addEventListener('click', () => {
            const isRegisterMode = authForm.dataset.mode === 'register';
            authForm.dataset.mode = isRegisterMode ? 'login' : 'register';
            D('form-title').textContent = isRegisterMode ? 'Acesse o SocialHub' : 'Cadastre-se para Evoluir';
            D('auth-button').textContent = isRegisterMode ? 'ENTRAR' : 'CADASTRAR';
            D('name-input').classList.toggle('hidden', !isRegisterMode);
            D('toggle-link').textContent = isRegisterMode 
                ? 'Ainda n√£o tem conta? Clique para Cadastrar'
                : 'J√° tem conta? Clique para Entrar';
        });

        // Bot√£o Sair
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.showError('Desconectado. At√© breve na luz-evolu√ß√£o.', false);
            } catch (e) {
                window.showError('Erro ao sair.');
            }
        });


        // --- GEMINI CO-CRIA√á√ÉO E PROTE√á√ÉO (TOXICIDADE) ---

        /**
         * Chamada gen√©rica para a API Gemini.
         * @param {string} prompt O prompt do usu√°rio.
         * @param {string} systemInstruction A instru√ß√£o de sistema para guiar o modelo.
         * @param {object} responseSchema O schema JSON para resposta estruturada.
         */
        const callGemini = async (prompt, systemInstruction, responseSchema = null) => {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            if (responseSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                };
            }

            // Implementa√ß√£o de Backoff Exponencial
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const response = await fetch(GEMINI_API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        return responseSchema ? JSON.parse(text) : text;
                    }
                    return null;
                } catch (error) {
                    if (attempt < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        continue;
                    }
                    console.error("Erro final na chamada Gemini:", error);
                    window.showError("Erro na comunica√ß√£o com a IA (Gemini).");
                    return null;
                }
            }
        };

        // Co-Cria√ß√£o de Post (Expandir Ideia)
        aiButtonExpanded.addEventListener('click', async () => {
            const originalContent = postContentInput.value.trim();
            if (!originalContent) {
                window.showError("Digite algo primeiro para a Co-cria√ß√£o de Gemini.");
                return;
            }

            postContentInput.disabled = true;
            aiButtonExpanded.innerHTML = '<svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.962 8.962 0 0010.5 4M10 20a8 8 0 01-5.356-2.008M20 12h-4.418"></path></svg><span class="text-sm hidden sm:inline">Co-criando...</span>';

            const systemPrompt = "Voc√™ √© um mentor de 'Luz-Evolu√ß√£o'. Expanda o texto fornecido em um post mais inspirador e completo, focando nos princ√≠pios de amor, prote√ß√£o e co-cria√ß√£o. O texto deve ter entre 100 e 200 caracteres e ser formatado em um √∫nico par√°grafo.";
            const newContent = await callGemini(originalContent, systemPrompt);

            postContentInput.disabled = false;
            aiButtonExpanded.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4M3 19h4m-4-7h16m0 0a8 8 0 10-16 0h16z"></path></svg><span class="text-sm hidden sm:inline">Gemini Co-Cria√ß√£o</span>';

            if (newContent) {
                postContentInput.value = newContent;
                window.showError("Postagem aprimorada pelo Gemini (Co-cria√ß√£o).", false);
            }
        });

        // --- FEED GLOBAL (Posts) ---

        /** Renderiza um post na timeline */
        const renderPost = (post, postId) => {
            const isLiked = post.likes?.[currentUserId] === true;
            const likeCount = Object.keys(post.likes || {}).length;

            const postElement = document.createElement('div');
            postElement.className = 'p-4 border border-gray-100 rounded-xl shadow-md bg-white';
            postElement.innerHTML = `
                <div class="flex items-center justify-between mb-3 border-b pb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-purple-200 rounded-full flex items-center justify-center text-primary-purple font-semibold text-sm">${post.userName.charAt(0).toUpperCase()}</div>
                        <div>
                            <p class="font-semibold text-gray-800">${post.userName}</p>
                            <p class="text-xs text-gray-500">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'agora'}</p>
                        </div>
                    </div>
                </div>
                <p class="text-gray-700 whitespace-pre-wrap">${post.content}</p>
                <div class="flex space-x-4 mt-3 pt-3 border-t border-gray-100">
                    <button data-post-id="${postId}" class="like-button flex items-center space-x-1 p-2 rounded-full hover:bg-gray-100 transition duration-150">
                        <svg class="w-5 h-5 like-icon ${isLiked ? 'liked' : 'not-liked'}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                        <span class="text-sm font-medium text-gray-600">${likeCount}</span>
                    </button>
                    <!-- Coment√°rio: Bot√£o de Intera√ß√£o (Pr√≥ximo ciclo de co-cria√ß√£o) -->
                    <button class="comment-button flex items-center space-x-1 p-2 rounded-full hover:bg-gray-100 transition duration-150 text-gray-500">
                         <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm7 0h-2v2h2V8z" clip-rule="evenodd"></path></svg>
                        <span class="text-sm font-medium">Comentar</span>
                    </button>
                </div>
            `;
            return postElement;
        };

        /** Alterna o estado de Like (Amor e Prote√ß√£o). */
        const toggleLike = async (postId) => {
            if (!db || !currentUserId) {
                window.showError('Voc√™ precisa estar logado para interagir.');
                return;
            }

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);

            try {
                const docSnap = await getDoc(postRef);
                if (!docSnap.exists()) return;

                const postData = docSnap.data();
                const isCurrentlyLiked = postData.likes?.[currentUserId] === true;

                const updatePayload = {};
                // O Firestore n√£o permite o uso direto de map field deletion/update,
                // mas permite a atualiza√ß√£o de campos aninhados.
                if (isCurrentlyLiked) {
                    // Remover o like (setar para null ou usar delete field, mas para compatibilidade, usaremos um objeto simples)
                    updatePayload[`likes.${currentUserId}`] = null; // Firestore ignora nulls, mas aqui usamos setDoc para sobrescrever se o campo fosse um array/map
                    // Usaremos setDoc com merge: true e a nota√ß√£o de ponto
                    await updateDoc(postRef, {
                        [`likes.${currentUserId}`]: isLiked ? deleteField() : true // Note: deleteField needs to be imported, simpler to set likes map correctly.
                    });
                    
                    // Estrat√©gia mais segura sem deleteField (simplesmente sobrescreve o mapa de likes no front e re-seta no back. No entanto, usaremos a maneira mais correta de update aninhado.)
                    await updateDoc(postRef, {
                        [`likes.${currentUserId}`]: null // Firestore ignora null updates, mas podemos usar updateDoc com set para undefined para remover. No Canvas, setar para um valor que n√£o ser√° lido √© mais seguro.
                    });
                    
                    // Para fins de compatibilidade no Canvas, onde deleteField pode falhar em imports complexos, vamos re-implementar o like/unlike usando um SET completo do mapa de likes.
                    const newLikes = { ...postData.likes };
                    if (isCurrentlyLiked) {
                        delete newLikes[currentUserId];
                    } else {
                        newLikes[currentUserId] = true;
                    }
                    await updateDoc(postRef, { likes: newLikes });
                    
                } else {
                    // Adicionar o like
                    await updateDoc(postRef, {
                        [`likes.${currentUserId}`]: true
                    });
                }


            } catch (e) {
                console.error("Erro ao atualizar like:", e);
                window.showError("Falha ao processar o like.");
            }
        };


        /** Carrega e ouve por novos posts em tempo real. */
        const loadFeed = () => {
            if (!db) return;
            const postsColRef = collection(db, `artifacts/${appId}/public/data/posts`);
            const q = query(postsColRef);

            onSnapshot(q, (snapshot) => {
                feedContainer.innerHTML = '';
                if (snapshot.empty) {
                    feedContainer.innerHTML = '<p class="text-center text-gray-500 p-4 bg-white rounded-lg">Nenhum post na linha do tempo. Seja o primeiro a co-criar!</p>';
                    return;
                }

                const postsArray = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    postsArray.push({ id: doc.id, ...data });
                });

                // Ordena por timestamp decrescente (mais recente primeiro)
                postsArray.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                postsArray.forEach(post => {
                    const postElement = renderPost(post, post.id);
                    feedContainer.appendChild(postElement);
                });

                // Adiciona listeners aos bot√µes de like e coment√°rios ap√≥s a renderiza√ß√£o
                document.querySelectorAll('.like-button').forEach(button => {
                    button.onclick = () => toggleLike(button.getAttribute('data-post-id'));
                });
                document.querySelectorAll('.comment-button').forEach(button => {
                    button.onclick = () => window.showError('Coment√°rios ser√£o implementados no pr√≥ximo ciclo de co-cria√ß√£o.', false);
                });
            }, (error) => {
                console.error("Erro ao carregar feed:", error);
                feedContainer.innerHTML = '<p class="text-center text-danger-red p-4 bg-red-100 rounded-lg">Erro ao carregar feed. Verifique sua conex√£o.</p>';
            });
        };
        

        // Submiss√£o do Post (com Prote√ß√£o Gemini)
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = postContentInput.value.trim();
            const publishButton = D('publish-button');

            if (!db || !currentUserId) {
                window.showError('Voc√™ precisa estar logado para publicar.');
                return;
            }
            if (!content) return;

            publishButton.textContent = 'Verificando Frequ√™ncia...';
            publishButton.disabled = true;

            // 1. CHAVE DE PROTE√á√ÉO GEMINI (Toxicity Check)
            const schema = {
                type: "OBJECT",
                properties: {
                    isHarmful: { type: "BOOLEAN", description: "True se o conte√∫do for t√≥xico, desarm√¥nico, ofensivo, ou de baixa frequ√™ncia." },
                    reason: { type: "STRING", description: "Breve explica√ß√£o do porqu√™ o conte√∫do √© t√≥xico." }
                },
                required: ["isHarmful", "reason"]
            };
            const systemPrompt = "Voc√™ √© o 'Escudo de Conte√∫do Gemini'. Analise a inten√ß√£o e a toxicidade do texto. Responda APENAS com um objeto JSON. Se o texto for t√≥xico, ofensivo, ou promover √≥dio, defina isHarmful como true. Caso contr√°rio, defina como false.";
            
            const protectionResult = await callGemini(content, systemPrompt, schema);

            if (protectionResult && protectionResult.isHarmful) {
                // Conte√∫do t√≥xico detectado, exibe modal de aviso (Prote√ß√£o)
                D('ai-warning-modal').classList.remove('hidden');
                publishButton.textContent = 'Publicar';
                publishButton.disabled = false;
                
                // Prepara para a decis√£o do usu√°rio
                aiPublishAnywayButton.onclick = () => handlePostSubmission(content, publishButton);
                aiReviewButton.onclick = () => {
                    D('ai-warning-modal').classList.add('hidden');
                    publishButton.disabled = false;
                };
            } else {
                // Conte√∫do seguro, publica diretamente
                handlePostSubmission(content, publishButton);
            }
        });

        // Fun√ß√£o para finalizar a submiss√£o do Post
        const handlePostSubmission = async (content, publishButton) => {
            D('ai-warning-modal').classList.add('hidden');
            publishButton.textContent = 'Publicando...';
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), {
                    userId: currentUserId,
                    userName: currentUserName,
                    content: content,
                    timestamp: serverTimestamp(),
                    likes: {} // Inicializa o mapa de likes
                });
                
                window.showError('Postagem co-criada com sucesso!', false);
                window.toggleComposer(false); // Fecha e limpa o compositor
            } catch (e) {
                window.showError(`Erro ao publicar: ${e.message}`);
            } finally {
                publishButton.textContent = 'Publicar';
                publishButton.disabled = false;
            }
        };


        // --- CHAT GLOBAL (Mensagens) ---

        /** Renderiza uma bolha de mensagem. */
        const renderMessage = (msg) => {
            const isMyMessage = msg.userId === currentUserId;
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
            messageElement.innerHTML = `
                <div class="message-bubble ${isMyMessage ? 'my-message' : 'other-message'}">
                    ${!isMyMessage ? `<p class="font-semibold text-xs mb-1 ${msg.userName === 'Gemini' ? 'text-yellow-300' : 'text-primary-purple'}">${msg.userName}</p>` : ''}
                    <p class="text-sm">${msg.content}</p>
                    <p class="text-xs mt-1 opacity-70 ${isMyMessage ? 'text-white' : 'text-gray-500'}">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('pt-PT') : 'agora'}</p>
                </div>
            `;
            return messageElement;
        };

        /** Carrega e ouve novas mensagens em tempo real. */
        const loadChat = () => {
            if (!db) return;
            const chatColRef = collection(db, `artifacts/${appId}/public/data/chat`);
            const q = query(chatColRef);

            onSnapshot(q, (snapshot) => {
                messagesFeed.innerHTML = '';
                
                if (snapshot.empty) {
                    messagesFeed.innerHTML = '<p class="text-center text-gray-500 text-sm pt-4" id="loading-messages-chat">Inicie uma nova conversa na Sala de Evolu√ß√£o Global.</p>';
                    return;
                }

                const messagesArray = [];
                snapshot.forEach(doc => messagesArray.push({ id: doc.id, ...doc.data() }));

                // Ordena por timestamp ascendente para chat (mais antigo primeiro, mas exibido em ordem reversa)
                messagesArray.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                messagesArray.forEach(msg => {
                    messagesFeed.appendChild(renderMessage(msg));
                });
                
                // Rola para o final
                messagesFeed.scrollTop = messagesFeed.scrollHeight;
            }, (error) => {
                console.error("Erro ao carregar chat:", error);
                messagesFeed.innerHTML = '<p class="text-center text-danger-red text-sm pt-4">Erro ao carregar mensagens.</p>';
            });
        };

        // Envio de Mensagem
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInput.value.trim();
            if (!db || !currentUserId || !content) return;

            messageInput.value = ''; // Limpa antes do envio para melhor UX
            messageInput.disabled = true;
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/chat`), {
                    userId: currentUserId,
                    userName: currentUserName,
                    content: content,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                window.showError(`Erro ao enviar mensagem: ${e.message}`);
                messageInput.value = content; // Restaura em caso de erro
            } finally {
                messageInput.disabled = false;
            }
        });


        // --- ESPA√áO PESSOAL (Notas Privadas) ---
        
        /** Renderiza uma nota privada. */
        const renderPrivateNote = (note, noteId) => {
            const noteElement = document.createElement('div');
            noteElement.className = 'p-3 bg-gray-50 border border-gray-200 rounded-lg shadow-sm flex justify-between items-start';
            noteElement.innerHTML = `
                <div class="flex-grow pr-4">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${note.content}</p>
                    <p class="text-xs text-gray-400 mt-2">${note.timestamp ? new Date(note.timestamp.toDate()).toLocaleString() : 'agora'}</p>
                </div>
                <button data-note-id="${noteId}" class="delete-note-button text-xs font-semibold text-danger-red hover:text-red-700 transition">
                    [Apagar]
                </button>
            `;
            return noteElement;
        };

        /** Deleta uma nota privada. */
        const deletePrivateNote = async (noteId) => {
             if (!db || !currentUserId) return;
             const noteRef = doc(db, `artifacts/${appId}/users/${currentUserId}/private_notes`, noteId);
             try {
                await deleteDoc(noteRef);
                window.showError('Nota removida do seu espa√ßo pessoal.', false);
             } catch (e) {
                window.showError(`Erro ao apagar nota: ${e.message}`);
             }
        };

        /** Carrega e ouve por notas privadas em tempo real. */
        const loadPrivateNotes = () => {
            if (!db || !currentUserId) return;
            const notesColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/private_notes`);
            const q = query(notesColRef);

            onSnapshot(q, (snapshot) => {
                privateNotesFeed.innerHTML = '';
                
                if (snapshot.empty) {
                    privateNotesFeed.innerHTML = '<p class="text-center text-gray-500 text-sm pt-4">Nenhuma anota√ß√£o salva. Use este espa√ßo para rascunhos pessoais.</p>';
                    return;
                }

                const notesArray = [];
                snapshot.forEach(doc => notesArray.push({ id: doc.id, ...doc.data() }));
                notesArray.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                notesArray.forEach(note => {
                    privateNotesFeed.appendChild(renderPrivateNote(note, note.id));
                });
                
                document.querySelectorAll('.delete-note-button').forEach(button => {
                    button.onclick = () => deletePrivateNote(button.getAttribute('data-note-id'));
                });
            }, (error) => {
                console.error("Erro ao carregar notas:", error);
                privateNotesFeed.innerHTML = '<p class="text-center text-danger-red text-sm pt-4">Erro ao carregar notas privadas.</p>';
            });
        };

        // Submiss√£o de Nota Privada
        privateNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = privateNoteContentInput.value.trim();
            const saveButton = D('save-note-button');
            
            if (!db || !currentUserId || !content) return;
            
            saveButton.textContent = 'Salvando...';
            saveButton.disabled = true;

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/private_notes`), {
                    content: content,
                    timestamp: serverTimestamp()
                });
                
                window.showError('Anota√ß√£o salva com sucesso no seu espa√ßo pessoal.', false);
                privateNoteContentInput.value = '';
            } catch (e) {
                window.showError(`Erro ao salvar nota: ${e.message}`);
            } finally {
                saveButton.textContent = 'Salvar Nota';
                saveButton.disabled = false;
            }
        });


        // --- SETUP FINAL E LISTENERS DE NAVEGA√á√ÉO ---
        
        // Inicializa o Firebase ao carregar a p√°gina
        initializeFirebase();

        // Adiciona listeners de navega√ß√£o
        document.querySelectorAll('.link-item').forEach(button => {
            button.addEventListener('click', (e) => {
                window.toggleView(e.currentTarget.getAttribute('data-view'));
            });
        });
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', (e) => {
                window.toggleView(e.currentTarget.getAttribute('data-view'));
            });
        });

        // Configura o estado inicial do formul√°rio de autentica√ß√£o
        authForm.dataset.mode = 'login'; 

    </script>
</body>
</html>
